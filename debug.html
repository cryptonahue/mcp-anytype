<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anytype JavaScript Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success { background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%); }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .response-area {
            margin-top: 20px;
        }
        
        .response-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 2px solid #4a5568;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-info { background: #bee3f8; color: #2a69ac; }
        .status-warning { background: #fefcbf; color: #744210; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        
        .comparison-item h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Anytype JavaScript Debug Tool</h1>
            <p>Herramienta avanzada usando el c√≥digo oficial de la documentaci√≥n</p>
        </div>
        
        <div class="content">
            <!-- Configuraci√≥n -->
            <div class="section">
                <h2>‚öôÔ∏è Configuraci√≥n</h2>
                <div class="grid">
                    <div class="form-group">
                        <label>API Base URL:</label>
                        <input type="text" id="apiUrl" value="http://localhost:31009">
                    </div>
                    <div class="form-group">
                        <label>API Version:</label>
                        <select id="apiVersion">
                            <option value="2025-05-20">2025-05-20 (Actual)</option>
                            <option value="2025-04-22">2025-04-22</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Authorization Token:</label>
                    <input type="password" id="apiToken" value="xtVSxolbbxsUsgv49p4cCgfv//HAl7HB09DCupT4KEM=" placeholder="Bearer token">
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Space ID:</label>
                        <input type="text" id="spaceId" value="bafyreieezkotenzua6722avng7ywgihgi6yn2fd2s56qt4acxroxmvz4gu.1mmy9s6wnxg7">
                    </div>
                    <div class="form-group">
                        <label>Object ID:</label>
                        <input type="text" id="objectId" value="bafyreibndmhoeycnim3b3ay5aoefjehv3sfizwi3n4ypmmwuhw3prvkvbi">
                    </div>
                </div>
            </div>

            <!-- Tests R√°pidos -->
            <div class="section">
                <h2>üß™ Tests Sistem√°ticos</h2>
                <div class="test-grid">
                    <button class="btn btn-success" onclick="getCurrentObject()">üìÑ Obtener Objeto Actual</button>
                    <button class="btn btn-warning" onclick="testUpdateName()">‚úèÔ∏è Test: Solo Nombre</button>
                    <button class="btn btn-warning" onclick="testUpdateIcon()">üéØ Test: Solo Icono</button>
                    <button class="btn btn-danger" onclick="testUpdateMarkdown()">üìù Test: Solo Markdown</button>
                    <button class="btn btn-danger" onclick="testUpdateProperties()">üîß Test: Solo Propiedades</button>
                    <button class="btn" onclick="testUpdateAll()">üîÑ Test: Todo Junto</button>
                    <button class="btn btn-info" onclick="compareStates()">üîç Comparar Estados</button>
                    <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
                </div>
            </div>

            <!-- Editor Manual -->
            <div class="section">
                <h2>‚úèÔ∏è Editor Manual</h2>
                <div class="form-group">
                    <label>Payload JSON personalizado:</label>
                    <textarea id="customPayload" placeholder='{"name": "Mi objeto", "markdown": "# Contenido\n\n¬°Hola mundo!"}'></textarea>
                </div>
                <button class="btn btn-success" onclick="sendCustomPayload()">üöÄ Enviar Payload Personalizado</button>
                <button class="btn btn-info" onclick="loadOfficialExample()">üìã Cargar Ejemplo Oficial</button>
            </div>

            <!-- √Årea de Respuesta -->
            <div class="section response-area">
                <h2>üìä Logs de Debug</h2>
                <div id="statusBadge"></div>
                <div class="response-box" id="responseBox">
üöÄ Anytype JavaScript Debug Tool Iniciado

üìã Configuraci√≥n cargada:
   - API: http://localhost:31009
   - Version: 2025-05-20
   - Space ID: bafyrei...
   - Object ID: bafyrei...

üí° Instrucciones:
1. Verifica la configuraci√≥n arriba
2. Usa "Obtener Objeto Actual" para ver el estado inicial
3. Prueba las actualizaciones sistem√°ticamente
4. Compara estados para ver qu√© cambi√≥

¬°Empecemos a debuggear! üîß
                </div>
            </div>

            <!-- Comparador de Estados -->
            <div class="section" id="comparisonSection" style="display: none;">
                <h2>üîç Comparaci√≥n de Estados</h2>
                <div class="comparison">
                    <div class="comparison-item">
                        <h4>üìÑ Estado ANTES</h4>
                        <div id="stateBefore" class="code-block">Ejecuta "Obtener Objeto Actual" primero</div>
                    </div>
                    <div class="comparison-item">
                        <h4>üìÑ Estado DESPU√âS</h4>
                        <div id="stateAfter" class="code-block">Ejecuta alguna actualizaci√≥n</div>
                    </div>
                </div>
                <div id="differences"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentState = null;
        let previousState = null;
        let testHistory = [];

        // Funciones de utilidad
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const responseBox = document.getElementById('responseBox');
            const colors = {
                success: '‚úÖ',
                error: '‚ùå', 
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                debug: 'üîß'
            };
            
            responseBox.textContent += `\n[${timestamp}] ${colors[type]} ${message}`;
            responseBox.scrollTop = responseBox.scrollHeight;
            
            // Actualizar badge de status
            updateStatusBadge(type, message);
        }

        function updateStatusBadge(type, message) {
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.className = `status-badge status-${type}`;
            statusBadge.textContent = message;
        }

        function clearLogs() {
            document.getElementById('responseBox').textContent = 'üßπ Logs limpiados. Listo para nuevas pruebas.';
            document.getElementById('statusBadge').textContent = '';
            testHistory = [];
        }

        // Funci√≥n principal para hacer requests
        async function makeAnytypeRequest(payload = null, description = '') {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiVersion = document.getElementById('apiVersion').value;
            const apiToken = document.getElementById('apiToken').value;
            const spaceId = document.getElementById('spaceId').value;
            const objectId = document.getElementById('objectId').value;

            if (!apiToken) {
                log('Error: Token requerido', 'error');
                return null;
            }

            const url = `${apiUrl}/v1/spaces/${spaceId}/objects/${objectId}`;
            
            log(`üîß ${description || 'Request'}: ${payload ? 'PATCH' : 'GET'} ${url}`, 'debug');
            
            if (payload) {
                log(`üì¶ Payload: ${JSON.stringify(payload, null, 2)}`, 'debug');
            }

            // Usar el formato exacto de la documentaci√≥n oficial
            const myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");
            myHeaders.append("Accept", "application/json");
            myHeaders.append("Anytype-Version", apiVersion);
            myHeaders.append("Authorization", `Bearer ${apiToken}`);

            const requestOptions = {
                method: payload ? "PATCH" : "GET",
                headers: myHeaders,
                redirect: "follow"
            };

            if (payload) {
                requestOptions.body = JSON.stringify(payload);
            }

            try {
                const response = await fetch(url, requestOptions);
                const result = await response.text();
                
                log(`üìä Response Status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                let parsedResult;
                try {
                    parsedResult = JSON.parse(result);
                } catch (e) {
                    parsedResult = result;
                }

                if (response.ok) {
                    log(`‚úÖ ${description || 'Request'} exitoso`, 'success');
                    
                    // Guardar estado si es GET
                    if (!payload) {
                        previousState = currentState;
                        currentState = parsedResult;
                    }
                    
                    // Guardar en historial
                    testHistory.push({
                        timestamp: new Date().toISOString(),
                        description,
                        payload,
                        response: parsedResult,
                        status: response.status
                    });
                    
                    log(`üìÑ Respuesta: ${JSON.stringify(parsedResult, null, 2)}`, 'debug');
                    return parsedResult;
                    
                } else {
                    log(`‚ùå Error ${response.status}: ${JSON.stringify(parsedResult, null, 2)}`, 'error');
                    return null;
                }

            } catch (error) {
                log(`üí• Network Error: ${error.message}`, 'error');
                return null;
            }
        }

        // Tests espec√≠ficos
        async function getCurrentObject() {
            log('\nüß™ TEST: Obteniendo estado actual del objeto...', 'info');
            await makeAnytypeRequest(null, 'Obtener Estado Actual');
        }

        async function testUpdateName() {
            log('\nüß™ TEST: Actualizando SOLO el nombre...', 'info');
            const timestamp = new Date().toLocaleTimeString();
            const payload = {
                name: `Debug JS Test - ${timestamp}`
            };
            await makeAnytypeRequest(payload, 'Update Name Only');
        }

        async function testUpdateIcon() {
            log('\nüß™ TEST: Actualizando SOLO el icono...', 'info');
            const payload = {
                icon: {
                    emoji: "üî•",
                    format: "emoji"
                }
            };
            await makeAnytypeRequest(payload, 'Update Icon Only');
        }

        async function testUpdateMarkdown() {
            log('\nüß™ TEST: Actualizando SOLO el markdown...', 'info');
            const timestamp = new Date().toISOString();
            const payload = {
                markdown: `# üöÄ Debug Test JavaScript

**Timestamp:** ${timestamp}

Este contenido fue actualizado usando la herramienta JavaScript debug.

## ‚úÖ Informaci√≥n del test:
- **M√©todo:** JavaScript fetch() con headers oficiales
- **Timestamp:** ${timestamp}
- **Herramienta:** anytype-js-debug-tool

## üéØ Contenido de prueba:
- Lista item A üî•
- Lista item B ‚ö°
- Lista item C üöÄ

**Texto en negrita** y *texto en cursiva*.

> Este es un blockquote de prueba

\`\`\`javascript
// C√≥digo de ejemplo
console.log("¬°Markdown actualizado correctamente!");
\`\`\`

---

üéâ **Si ves esto, el markdown funciona perfectamente!**`
            };
            await makeAnytypeRequest(payload, 'Update Markdown Only');
        }

        async function testUpdateProperties() {
            log('\nüß™ TEST: Actualizando SOLO las propiedades...', 'info');
            const payload = {
                properties: [
                    {
                        format: "text",
                        key: "description",
                        text: `Debug test from JS - ${new Date().toLocaleTimeString()}`
                    }
                ]
            };
            await makeAnytypeRequest(payload, 'Update Properties Only');
        }

        async function testUpdateAll() {
            log('\nüß™ TEST: Actualizando TODO (nombre + markdown + icono)...', 'info');
            const timestamp = new Date().toISOString();
            const payload = {
                name: `Complete JS Test - ${new Date().toLocaleTimeString()}`,
                icon: {
                    emoji: "‚ö°",
                    format: "emoji"
                },
                markdown: `# üéØ Test Completo JavaScript

**Timestamp:** ${timestamp}

## üîÑ Actualizaci√≥n completa realizada:
- ‚úÖ Nombre actualizado
- ‚úÖ Icono actualizado  
- ‚úÖ Markdown actualizado

¬°Todo funcionando perfectamente! üéâ`,
                properties: [
                    {
                        format: "text", 
                        key: "description",
                        text: `Complete update test - ${timestamp}`
                    }
                ]
            };
            await makeAnytypeRequest(payload, 'Update All Fields');
        }

        async function sendCustomPayload() {
            const customPayload = document.getElementById('customPayload').value;
            if (!customPayload.trim()) {
                log('Error: Payload personalizado vac√≠o', 'error');
                return;
            }

            try {
                const payload = JSON.parse(customPayload);
                log('\nüß™ TEST: Enviando payload personalizado...', 'info');
                await makeAnytypeRequest(payload, 'Custom Payload');
            } catch (error) {
                log(`Error: JSON inv√°lido - ${error.message}`, 'error');
            }
        }

        function loadOfficialExample() {
            const officialPayload = {
                "icon": {
                    "emoji": "üìÑ",
                    "format": "emoji"
                },
                "name": "My object from official docs",
                "properties": [
                    {
                        "format": "text",
                        "key": "description", 
                        "text": "Some text from official example..."
                    },
                    {
                        "format": "number",
                        "key": "height",
                        "number": 42
                    },
                    {
                        "checkbox": true,
                        "format": "checkbox",
                        "key": "done"
                    },
                    {
                        "format": "url",
                        "key": "source",
                        "url": "https://example.com"
                    },
                    {
                        "email": "example@example.com",
                        "format": "email", 
                        "key": "email"
                    },
                    {
                        "format": "phone",
                        "key": "phone",
                        "phone": "+1234567890"
                    }
                ]
            };
            
            document.getElementById('customPayload').value = JSON.stringify(officialPayload, null, 2);
            log('üìã Ejemplo oficial cargado en el editor', 'info');
        }

        function compareStates() {
            if (!currentState || !previousState) {
                log('Error: Necesitas tener al menos dos estados para comparar', 'error');
                return;
            }

            const comparisonSection = document.getElementById('comparisonSection');
            comparisonSection.style.display = 'block';

            document.getElementById('stateBefore').textContent = JSON.stringify(previousState, null, 2);
            document.getElementById('stateAfter').textContent = JSON.stringify(currentState, null, 2);

            // Analizar diferencias b√°sicas
            const differences = [];
            
            if (currentState.object) {
                const before = previousState.object || {};
                const after = currentState.object || {};

                // Comparar campos principales
                if (before.name !== after.name) {
                    differences.push(`üè∑Ô∏è Nombre: "${before.name}" ‚Üí "${after.name}"`);
                }
                
                if (JSON.stringify(before.icon) !== JSON.stringify(after.icon)) {
                    differences.push(`üéØ Icono: Cambi√≥`);
                }
                
                if (before.markdown !== after.markdown) {
                    differences.push(`üìù Markdown: ${before.markdown?.length || 0} ‚Üí ${after.markdown?.length || 0} caracteres`);
                }
                
                if (before.snippet !== after.snippet) {
                    differences.push(`üìÑ Snippet: Cambi√≥`);
                }

                // Comparar fechas de modificaci√≥n
                const beforeDate = before.properties?.find(p => p.key === 'last_modified_date')?.date;
                const afterDate = after.properties?.find(p => p.key === 'last_modified_date')?.date;
                if (beforeDate !== afterDate) {
                    differences.push(`‚è∞ Fecha modificaci√≥n: ${beforeDate} ‚Üí ${afterDate}`);
                }
            }

            const differencesDiv = document.getElementById('differences');
            if (differences.length > 0) {
                differencesDiv.innerHTML = `
                    <div class="comparison-item">
                        <h4>üîç Diferencias Encontradas:</h4>
                        <ul style="margin-left: 20px;">
                            ${differences.map(diff => `<li>${diff}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                differencesDiv.innerHTML = `
                    <div class="comparison-item">
                        <h4>‚ö†Ô∏è Sin Diferencias</h4>
                        <p>No se encontraron diferencias entre los estados.</p>
                    </div>
                `;
            }

            log('üîç Comparaci√≥n de estados realizada - revisa la secci√≥n de abajo', 'success');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Herramienta JavaScript Debug inicializada', 'success');
            log('üí° Tip: Usa las DevTools del navegador (F12) para m√°s detalles', 'info');
        });
    </script>
</body>
</html>